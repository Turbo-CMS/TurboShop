/*!
 * Tiny AI plugin
 *
 * Copyright (c) 2023 Ephox Corporation DBA Tiny Technologies, Inc.
 * Licensed under the Tiny commercial license. See https://www.tiny.cloud/legal/
 *
 * Version: 7.5.1-113
 */

!function(){"use strict";const e=e=>parseInt(e,10),t=(e,t)=>{const n=e-t;return 0===n?0:n>0?1:-1},n=(e,t,n)=>({major:e,minor:t,patch:n}),o=t=>{const o=/([0-9]+)\.([0-9]+)\.([0-9]+)(?:(\-.+)?)/.exec(t);return o?n(e(o[1]),e(o[2]),e(o[3])):n(0,0,0)},r=e=>t=>(e=>{const t=typeof e;return null===e?"null":"object"===t&&Array.isArray(e)?"array":"object"===t&&(n=o=e,(r=String).prototype.isPrototypeOf(n)||(null===(a=o.constructor)||void 0===a?void 0:a.name)===r.name)?"string":t;var n,o,r,a})(t)===e,a=e=>t=>typeof t===e,s=r("string"),i=r("object"),l=r("array"),c=a("boolean"),p=e=>!(e=>null==e)(e),u=a("function"),m=()=>{};function g(e,...t){return(...n)=>{const o=t.concat(n);return e.apply(null,o)}}const d=e=>{e()},h=()=>!1;class y{constructor(e,t){this.tag=e,this.value=t}static some(e){return new y(!0,e)}static none(){return y.singletonNone}fold(e,t){return this.tag?t(this.value):e()}isSome(){return this.tag}isNone(){return!this.tag}map(e){return this.tag?y.some(e(this.value)):y.none()}bind(e){return this.tag?e(this.value):y.none()}exists(e){return this.tag&&e(this.value)}forall(e){return!this.tag||e(this.value)}filter(e){return!this.tag||e(this.value)?this:y.none()}getOr(e){return this.tag?this.value:e}or(e){return this.tag?this:e}getOrThunk(e){return this.tag?this.value:e()}orThunk(e){return this.tag?this:e()}getOrDie(e){if(this.tag)return this.value;throw new Error(null!=e?e:"Called getOrDie on None")}static from(e){return p(e)?y.some(e):y.none()}getOrNull(){return this.tag?this.value:null}getOrUndefined(){return this.value}each(e){this.tag&&e(this.value)}toArray(){return this.tag?[this.value]:[]}toString(){return this.tag?`some(${this.value})`:"none()"}}y.singletonNone=new y(!1);const f=(e,t)=>{for(let n=0,o=e.length;n<o;n++)t(e[n],n)},b=Object.hasOwnProperty,v=(e,t)=>b.call(e,t),w=(e,t)=>e?y.some(t):y.none(),T="generate",A="insert",S="discard",E="stop",I="regenerate",x="prompt",C="AI shortcuts",R="ai-prompt",k="Integration Error: {0}.",O="Response was not a string",D="respondWith was not used",_="An error occurred.",N=[{title:"Summarize content",prompt:"Provide the key points and concepts in this content in a succinct summary.",selection:!0},{title:"Improve writing",prompt:"Rewrite this content with no spelling mistakes, proper grammar, and with more descriptive language, using best writing practices without losing the original meaning.",selection:!0},{title:"Simplify language",prompt:"Rewrite this content with simplified language and reduce the complexity of the writing, so that the content is easier to understand.",selection:!0},{title:"Expand upon",prompt:"Expand upon this content with descriptive language and more detailed explanations, to make the writing easier to understand and increase the length of the content.",selection:!0},{title:"Trim content",prompt:"Remove any repetitive, redundant, or non-essential writing in this content without changing the meaning or losing any key information.",selection:!0},{title:"Change tone",subprompts:[{title:"Professional",prompt:"Rewrite this content using polished, formal, and respectful language to convey professional expertise and competence.",selection:!0},{title:"Casual",prompt:"Rewrite this content with casual, informal language to convey a casual conversation with a real person.",selection:!0},{title:"Direct",prompt:"Rewrite this content with direct language using only the essential information.",selection:!0},{title:"Confident",prompt:"Rewrite this content using compelling, optimistic language to convey confidence in the writing.",selection:!0},{title:"Friendly",prompt:"Rewrite this content using friendly, comforting language, to convey understanding and empathy.",selection:!0}]},{title:"Change style",subprompts:[{title:"Business",prompt:"Rewrite this content as a business professional with formal language.",selection:!0},{title:"Legal",prompt:"Rewrite this content as a legal professional using valid legal terminology.",selection:!0},{title:"Journalism",prompt:"Rewrite this content as a journalist using engaging language to convey the importance of the information.",selection:!0},{title:"Medical",prompt:"Rewrite this content as a medical professional using valid medical terminology.",selection:!0},{title:"Poetic",prompt:"Rewrite this content as a poem using poetic techniques without losing the original meaning.",selection:!0}]},{title:"Translate",subprompts:[{title:"Translate to English",prompt:"Translate this content to English language.",selection:!0},{title:"Translate to Spanish",prompt:"Translate this content to Spanish language.",selection:!0},{title:"Translate to Portuguese",prompt:"Translate this content to Portuguese language.",selection:!0},{title:"Translate to German",prompt:"Translate this content to German language.",selection:!0},{title:"Translate to French",prompt:"Translate this content to French language.",selection:!0},{title:"Translate to Norwegian",prompt:"Translate this content to Norwegian language.",selection:!0},{title:"Translate to Ukrainian",prompt:"Translate this content to Ukrainian language.",selection:!0},{title:"Translate to Japanese",prompt:"Translate this content to Japanese language.",selection:!0},{title:"Translate to Korean",prompt:"Translate this content to Korean language.",selection:!0},{title:"Translate to Simplified Chinese",prompt:"Translate this content to Simplified Chinese language.",selection:!0},{title:"Translate to Hebrew",prompt:"Translate this content to Hebrew language.",selection:!0},{title:"Translate to Hindi",prompt:"Translate this content to Hindi language.",selection:!0},{title:"Translate to Arabic",prompt:"Translate this content to Arabic language.",selection:!0}]}],q=e=>t=>t.options.get(e),M=(j="ai_request",e=>(e=>t=>y.from(q(e)(t)).filter(u))(j)(e).getOrDie(j+" has not been implemented."));var j;const L=e=>y.from(q("ai_shortcuts")(e)).filter((e=>e.length>0)),P=q("body_class"),$=q("content_style"),U=q("content_css_cors"),B=(e,t)=>t.parse(e,{insert:!0}),H=(e,t)=>{e.execCommand("mceAiDialog",!1,t)},z=(e,t)=>n=>{const o=e=>()=>n.setEnabled(e),r=o(!1),a=e.mode.isReadOnly()?r:o(!0);return e.on("AIResponse AIError AIDialogClose",a),e.on("AIRequest",r),t.isInProgress()?r():a(),()=>{e.off("AIResponse AIError AIDialogClose",a),e.off("AIRequest",r)}},K=(e,t)=>n=>(n.setEnabled(y.from(t.selection).forall((t=>e.selection.isCollapsed()!==t))),m),J=(e,t)=>((t,n)=>{const o=t.length,r=new Array(o);for(let n=0;n<o;n++){const o=t[n];r[n]=(e=>{return v(t=e,n="subprompts")&&void 0!==t[n]&&null!==t[n];var t,n})(a=o)?((e,t)=>({type:"nestedmenuitem",text:t.title,getSubmenuItems:()=>J(e,t.subprompts)}))(e,a):((e,t)=>({type:"menuitem",text:t.title,value:t.prompt,onSetup:K(e,t),onAction:()=>H(e,{prompt:t.prompt,generate:!0,display:!1})}))(e,a)}var a;return r})(t),F=e=>(t,n)=>{const o=(r=s(n)?B(n,t.parser):n,a=t.schema,tinymce.html.Serializer({validate:!0},a).serialize(r));var r,a;const i=y.from($(t)).map((e=>`<style type="text/css">${e}</style>`)).getOr(""),l=y.from(U(t)).map((e=>e?' crossorigin="anonymous"':"")).getOr(""),c=(p=t.contentCSS,u=(e,n)=>`${e}<link type="text/css" rel="stylesheet" href="${t.documentBaseURI.toAbsolute(n)}"${l}>`,m="",f(p,((e,t)=>{m=u(m,e)})),m);var p,u,m;const g=t.dom.encode,d=`<body${y.from(P(t)).map((e=>` class="${g(e)}"`)).getOr("")}${y.from(t.getBody()).map((e=>g(e.dir))).bind((e=>w(""!==e,` dir="${e}"`))).getOr("")}>`,h=tinymce.Env.os,b='<script>document.addEventListener && document.addEventListener("click", function(e) {for (var elm = e.target; elm; elm = elm.parentNode) {if (elm.nodeName === "A" && !('+(h.isMacOS()||h.isiOS()?"e.metaKey":"e.ctrlKey && !e.altKey")+")) {e.preventDefault();}}}, false);<\/script> ",v=e?"<style>* { opacity: 80% }</style>":"";return`<!DOCTYPE html><html><head><base href="${g(t.documentBaseURI.getURI())}">`+c+i+"<style>table, table td, table th, table caption { border: 1px dashed #bbb }</style>"+v+b+"</head>"+d+o+"</body></html>"},G=F(!1),W=F(!0),V={prompt:"",generate:!1,display:!0},Q=e=>{let t=e;return{get:()=>t,set:e=>{t=e}}},Y=()=>{const e=(e=>{const t=Q(y.none()),n=()=>t.get().each(e);return{clear:()=>{n(),t.set(y.none())},isSet:()=>t.get().isSome(),get:()=>t.get(),set:e=>{n(),t.set(y.some(e))}}})(m);return{...e,on:t=>e.get().each(t)}},X=(e,t)=>e.dispatch("AIResponse",{response:t}),Z=(e,t)=>e.dispatch("AIError",{error:t}),ee=(e,t)=>{const n=tinymce.util.I18n,o=M(e),r=Y(),a=r.isSet,i=e=>()=>r.get().exists((t=>t===e)),l=i("stream"),c=i("string"),u=Y();return{isInProgress:a,isStream:l,isString:c,closeStream:()=>u.on(d),submitRequest:(a,i,l,c,m)=>{const g=new window.AbortController,d=g.signal;let h=!1;const y={string:o=>{(async o=>{const p="string";r.set(p),h=!0;try{const r=await o(d);if(!s(r)){const e=n.translate([k,O]);throw console.error(e,r),new TypeError(e)}const l={type:p,data:r};t.addNewThreadEvent(a,i,{response:l}),X(e,l),c(l.data)}catch(n){const o=n;t.addNewThreadEvent(a,i,{error:{type:p,error:o}}),Z(e,o),l(o)}finally{r.clear()}})(o)},stream:o=>{(async o=>{const p="stream";r.set(p),h=!0;let y="";const f=()=>{d.removeEventListener("abort",b),u.clear()},b=()=>{const n={type:p,data:y};t.addNewThreadEvent(a,i,{response:n}),X(e,n),c(y),f()};d.addEventListener("abort",b),u.set((()=>g.abort()));try{await o(d,(e=>{if(!s(e)){const t=n.translate([k,O]);throw console.error(t,e),new TypeError(t)}y+=e,m(y)})).then(b)}catch(n){u.on((e=>{f(),e()}));const o={type:p,data:y},r=n;t.addNewThreadEvent(a,i,{response:o,error:{type:p,error:r}}),X(e,o),Z(e,r),l(r)}finally{r.clear()}})(o)}},f=o(((n,o)=>{const r=((e,n)=>({thread:t.getThread(n).getOr([]),...e}))(n,o);return((e,t)=>{e.dispatch("AIRequest",{request:t})})(e,r),r})(a,i),y);if(p(f)&&console.warn("Integration Warning: ai_request return type was not void."),!h){const o=n.translate([k,D]);console.error(o),t.addNewThreadEvent(a,i,{error:{type:"invalid",error:o}}),Z(e,o),l(o)}}}};let te=0;const ne=e=>{const t=(new Date).getTime(),n=Math.floor(window.crypto.getRandomValues(new Uint32Array(1))[0]/4294967295*1e9);return te++,e+"_"+n+te+String(t)},oe=()=>{const e=Q({}),t=e.get,n=e.set,o=e=>y.from(t()[e]),r=(e,o)=>{const r=t();return r[e]=o,n(r),o};return{getThreadLog:t,setThreadLog:n,createThread:(e=[])=>{const t=ne("mce-aithread");return r(t,e),t},getThread:o,setThread:r,getLatestThreadEvent:e=>o(e).bind((e=>((e,t,n)=>{for(let o=0,r=e.length;o<r;o++){const r=e[o];if(t(r,o))return y.some(r);if(n(r,o))break}return y.none()})(e,(e=>v(e,"response")),h))),addNewThreadEvent:(e,t,n)=>{((e,t)=>{o(e).map((n=>r(e,t.concat(n))))})(t,[{eventUid:ne("mce-aithreadevent"),timestamp:(new Date).toISOString(),request:e,...n}])}}},re=["Answer the question based on the context below.","The response should be in HTML format.","The response should preserve any HTML formatting, links, and styles in the context."],ae=(e,t)=>`${re.join("\n")}\n\nContext:${t.map((e=>`"""${e}"""`)).getOr('""')}\n\nQuestion: """${e}"""\n\nAnswer:`,se={type:"input",name:x,placeholder:"Ask AI to edit or generate...",maximized:!0},ie=e=>({type:"button",name:T,text:"Generate",icon:"send",buttonType:e?"primary":"secondary"}),le={type:"bar",items:[se,ie(!0)]},ce=[le],pe=e=>({type:"iframe",name:"preview",border:!0,sandboxed:!1,streamContent:e,transparent:!0}),ue={type:"button",name:A,text:"Insert",buttonType:"primary"},me={type:"button",name:S,text:"Discard",buttonType:"secondary"},ge={...me,name:E,text:"Stop"},de={type:"button",name:I,text:"Try again",buttonType:"secondary"},he=e=>({type:"bar",items:[ue,de,e?ge:me]}),ye={type:"label",items:[],label:"AI responses can be inaccurate",align:"end"},fe=e=>({type:"grid",columns:2,items:[he(e),ye]}),be={type:"htmlpanel",html:""},ve={type:"bar",items:[se,ie(!1)]},we=e=>[pe(e),fe(e),be,ve],Te=we(!0),Ae=we(!1),Se=(e,t,n)=>{const o=Y(),r=Y(),a=Y(),i=Q(""),l=e=>t=>{t.setEnabled(E,!e),f([T,A,x,I],(n=>t.setEnabled(n,e)))},c=l(!1),p=l(!0),u=(e,t)=>{t.setEnabled(T,""!==e)},m=(t,o)=>{const r=Q(!1),l=(e,t)=>({...o,prompt:e,preview:t}),m=(e,n)=>{t.unblock(),t.redial(k(e,n))},g=("error",n=>{const r=((e,t)=>({type:"label",label:"",items:[{type:"alertbanner",level:t,text:e,icon:"warning"}]}))(n,"error");a.get().map((t=>G(e,t))).fold((()=>m((e=>[e,be,le])(r),l(o.prompt))),(e=>m((e=>[pe(!1),fe(!1),e,be,ve])(r),l(o.prompt,e)))),t.focus(x)});const d=e=>{const t=s(e)?e:e instanceof Error?e.message:_;g(t)},h=o=>{if(e.removed)return;const r=n.isStream();a.set(o);const s=G(e,o);if(r)t.setData({preview:s}),p(t);else{const e=l("",s);m(Ae,e)}u("",t),t.focus(x)},y=n=>{a.set(n),r.get()?t.setData({preview:W(e,n)}):((e,t)=>{const n=((e,t)=>{const n=B(e,t);let o=n;do{8===(null==o?void 0:o.type)&&o.remove()}while(o=null==o?void 0:o.walk());return n})(t,e.parser);return w((o=n,r=e.schema,!o.isEmpty(r.getNonEmptyElements(),r.getWhitespaceElements())),W(e,n));var o,r})(e,n).each((e=>{const n=l("",e);m(Te,n),c(t),r.set(!0)}))};if(""!==o.prompt){t.block("Awaiting response");const e=(f=o.prompt,b=o.context,{prompt:ae(f,b),query:f,context:b.getOr(""),system:re});n.submitRequest(e,i.get(),d,h,y)}var f,b},d=(t,n=t.getData())=>{const o={...n,context:a.get().or((e=>w(!e.selection.isCollapsed(),e.selection.getContent()))(e))};r.set(o),m(t,o)},h=e=>{o.set(e),o.on(d)},y=(t,o)=>{switch(t.name){case T:d(o);break;case A:a.on((t=>{o.close(),((e,t)=>{e.insertContent(t,{paste:!0})})(e,t)}));break;case E:n.closeStream();break;case S:o.close();break;case I:r.get().each((e=>m(o,e)))}},b=(e,t)=>{o.set(e),o.on(g(y,t))},v=(e,t)=>{const n=t.getData();e.name===x&&u(n.prompt,t)},C=(e,t)=>{o.set(e),o.on(g(v,t))},R=()=>{n.closeStream(),(e=>{e.dispatch("AIDialogClose")})(e),r.clear(),a.clear(),o.clear()},k=(e,t)=>({title:"AI Assistant",body:{type:"panel",items:e},size:"medium",initialData:t,onSubmit:h,onAction:b,onChange:C,onClose:R}),O=t=>{const n=t.display?ce:[],r=(e=>({prompt:e.prompt}))(t),a=k(n,r);o.set(e.windowManager.open(a,{inline:"bottom",persistent:!0})),o.on(g(u,t.prompt)),t.generate&&o.on((e=>d(e,r)))},D=()=>o.on((e=>e.close()));return{open:n=>{o.isSet()?(e=>!(e.generate&&e.prompt.length>0))(n)?o.on((e=>{e.focus(x)})):(e=>{o.on(D),O(e)})(n):(n=>{i.set(t.createThread()),(e=>{e.dispatch("AIDialogOpen")})(e),O(n)})(n)},close:D}};tinymce.PluginManager.requireLangPack("ai","ar,bg_BG,ca,cs,da,de,el,es,eu,fa,fi,fr_FR,he_IL,hi,hr,hu_HU,id,it,ja,kk,ko_KR,ms,nb_NO,nl,pl,pt_BR,pt_PT,ro,ru,sk,sl_SI,sv_SE,th_TH,tr,uk,vi,zh_CN,zh_TW"),tinymce.PluginManager.add("ai",(e=>{if(((e,n)=>!!e&&-1===((e,n)=>{const o=t(e.major,n.major);if(0!==o)return o;const r=t(e.minor,n.minor);if(0!==r)return r;const a=t(e.patch,n.patch);return 0!==a?a:0})((e=>o((e=>[e.majorVersion,e.minorVersion].join(".").split(".").slice(0,3).join("."))(e)))(e),o(n)))(tinymce,"6.6.0"))return console.error("The ai plugin requires at least version 6.6.0 of TinyMCE."),{};(e=>{const t=e.options.register;t("ai_request",{processor:"function"}),t("ai_shortcuts",{processor:e=>{if(c(e))return{valid:!0,value:e?N:[]};{const t=((e,t)=>{if(l(e)){for(let n=0,o=e.length;n<o;++n)if(!t(e[n]))return!1;return!0}return!1})(e,i);return t?{value:e,valid:t}:{valid:!1,message:"Must be a boolean, empty array, or an array of objects."}}},default:N})})(e);const n=oe(),r=ee(e,n);return((e,t)=>{e.addCommand("mceAiDialog",((e,n)=>{const o={...V,...n};t.open(o)})),e.addCommand("mceAiDialogClose",t.close)})(e,Se(e,n,r)),((e,t)=>{e.ui.registry.addMenuItem("aidialog",{icon:"ai",text:"Ask AI...",shortcut:"Meta+J",onSetup:z(e,t),onAction:()=>H(e)}),L(e).each((n=>{e.ui.registry.addNestedMenuItem("aishortcuts",{icon:R,text:C,onSetup:z(e,t),getSubmenuItems:()=>J(e,n)})}))})(e,r),((e,t)=>{e.ui.registry.addButton("aidialog",{icon:"ai",tooltip:"Ask AI",onSetup:z(e,t),onAction:()=>H(e)}),L(e).each((n=>{e.ui.registry.addMenuButton("aishortcuts",{icon:R,tooltip:C,onSetup:z(e,t),fetch:t=>t(J(e,n))})}))})(e,r),(e=>{e.ui.registry.addContextToolbar("ai",{predicate:t=>!e.selection.isCollapsed()&&e.dom.isEditable(t),items:"aidialog aishortcuts",position:"selection",scope:"editor"})})(e),(e=>{e.addShortcut("Meta+J","Open Ai Dialog",(()=>{e.execCommand("mceAiDialog")}))})(e),(e=>({getThreadLog:e.getThreadLog}))(n)}))}();